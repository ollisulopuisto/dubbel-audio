<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dubbel Audio - Kaksikanavainen soitin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .channel-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center p-4 md:p-8">
    <div class="max-w-4xl w-full">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Dubbel Audio</h1>
            <p class="text-slate-400">Lataa kaksi tiedostoa: toinen vasemmalle, toinen oikealle.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <!-- Vasen kanava -->
            <div class="channel-card p-6 rounded-2xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                    Vasen kanava (L)
                </h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-400 mb-2">Valitse tiedosto</label>
                    <input type="file" id="fileL" accept="audio/*" class="block w-full text-sm text-slate-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-500 file:text-white
                        hover:file:bg-blue-600
                        cursor-pointer">
                </div>

                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-400">Nopeus</label>
                            <span id="speedValL" class="text-blue-400 font-mono text-sm">0.5x</span>
                        </div>
                        <input type="range" id="speedL" min="0.1" max="4" step="0.1" value="0.5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="reverseL" class="w-4 h-4 text-blue-500 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                        <label for="reverseL" class="ml-2 text-sm font-medium text-slate-300">Soita takaperin</label>
                    </div>
                </div>
            </div>

            <!-- Oikea kanava -->
            <div class="channel-card p-6 rounded-2xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                    Oikea kanava (R)
                </h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-slate-400 mb-2">Valitse tiedosto</label>
                    <input type="file" id="fileR" accept="audio/*" class="block w-full text-sm text-slate-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-500 file:text-white
                        hover:file:bg-purple-600
                        cursor-pointer">
                </div>

                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-medium text-slate-400">Nopeus</label>
                            <span id="speedValR" class="text-purple-400 font-mono text-sm">1.5x</span>
                        </div>
                        <input type="range" id="speedR" min="0.1" max="4" step="0.1" value="1.5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="reverseR" class="w-4 h-4 text-purple-500 bg-slate-700 border-slate-600 rounded focus:ring-purple-500">
                        <label for="reverseR" class="ml-2 text-sm font-medium text-slate-300">Soita takaperin</label>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center gap-4">
            <div class="flex gap-4">
                <button id="playBtn" disabled class="px-8 py-3 bg-green-500 hover:bg-green-600 disabled:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-full transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    SOITA
                </button>
                <button id="stopBtn" disabled class="px-8 py-3 bg-red-500 hover:bg-red-600 disabled:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-full transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path></svg>
                    PYSÄYTÄ
                </button>
            </div>
            <p id="status" class="text-sm text-slate-500 italic">Lataa tiedostot aloittaaksesi</p>
        </div>
    </div>

    <script>
        let audioCtx;
        let bufferL, bufferR;
        let sourceL, sourceR;
        let isPlaying = false;

        const fileL = document.getElementById('fileL');
        const fileR = document.getElementById('fileR');
        const speedL = document.getElementById('speedL');
        const speedR = document.getElementById('speedR');
        const speedValL = document.getElementById('speedValL');
        const speedValR = document.getElementById('speedValR');
        const reverseL = document.getElementById('reverseL');
        const reverseR = document.getElementById('reverseR');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');

        // Alustetaan AudioContext käyttäjän eleestä (vältetään lukitus mobiilissa)
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        async function loadAudio(file) {
            initAudio();
            const arrayBuffer = await file.arrayBuffer();
            return await audioCtx.decodeAudioData(arrayBuffer);
        }

        fileL.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                status.textContent = 'Ladataan vasenta kanavaa...';
                try {
                    bufferL = await loadAudio(e.target.files[0]);
                    checkReady();
                } catch (err) {
                    status.textContent = 'Virhe tiedoston latauksessa';
                    console.error(err);
                }
            }
        });

        fileR.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                status.textContent = 'Ladataan oikeaa kanavaa...';
                try {
                    bufferR = await loadAudio(e.target.files[0]);
                    checkReady();
                } catch (err) {
                    status.textContent = 'Virhe tiedoston latauksessa';
                    console.error(err);
                }
            }
        });

        function checkReady() {
            if (bufferL && bufferR) {
                playBtn.disabled = false;
                status.textContent = 'Valmis toistoon';
            } else if (bufferL || bufferR) {
                status.textContent = 'Lataa vielä toinen tiedosto';
            }
        }

        speedL.addEventListener('input', (e) => {
            speedValL.textContent = e.target.value + 'x';
            if (sourceL) sourceL.playbackRate.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.1);
        });

        speedR.addEventListener('input', (e) => {
            speedValR.textContent = e.target.value + 'x';
            if (sourceR) sourceR.playbackRate.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.1);
        });

        function createReversedBuffer(originalBuffer) {
            const reversedBuffer = audioCtx.createBuffer(
                originalBuffer.numberOfChannels,
                originalBuffer.length,
                originalBuffer.sampleRate
            );

            for (let i = 0; i < originalBuffer.numberOfChannels; i++) {
                const chanData = originalBuffer.getChannelData(i);
                const revData = reversedBuffer.getChannelData(i);
                for (let j = 0, k = chanData.length - 1; j < chanData.length; j++, k--) {
                    revData[j] = chanData[k];
                }
            }
            return reversedBuffer;
        }

        playBtn.addEventListener('click', () => {
            initAudio();
            if (isPlaying) stop();
            
            isPlaying = true;
            playBtn.disabled = true;
            stopBtn.disabled = false;

            const merger = audioCtx.createChannelMerger(2);
            merger.connect(audioCtx.destination);

            function setupChannel(buffer, speed, reverse, channelIndex) {
                const source = audioCtx.createBufferSource();
                source.buffer = reverse ? createReversedBuffer(buffer) : buffer;
                source.playbackRate.value = speed;

                if (buffer.numberOfChannels > 1) {
                    const mixDown = audioCtx.createGain();
                    mixDown.gain.value = 1 / buffer.numberOfChannels;
                    source.connect(mixDown);
                    mixDown.connect(merger, 0, channelIndex);
                } else {
                    source.connect(merger, 0, channelIndex);
                }
                return source;
            }

            sourceL = setupChannel(bufferL, speedL.value, reverseL.checked, 0);
            sourceR = setupChannel(bufferR, speedR.value, reverseR.checked, 1);

            sourceL.start();
            sourceR.start();

            status.textContent = 'Toistetaan...';

            let endedCount = 0;
            const onEnded = () => {
                endedCount++;
                if (endedCount >= 2) stop();
            };
            sourceL.onended = onEnded;
            sourceR.onended = onEnded;
        });

        stopBtn.addEventListener('click', stop);

        function stop() {
            if (sourceL) {
                try { sourceL.stop(); } catch(e) {}
                sourceL = null;
            }
            if (sourceR) {
                try { sourceR.stop(); } catch(e) {}
                sourceR = null;
            }
            isPlaying = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = 'Toisto pysäytetty';
        }
    </script>
</body>
</html>
