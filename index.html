<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dubbel Audio - Kaksikanavainen soitin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .channel-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center p-4 md:p-8">
    <div class="max-w-4xl w-full">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Dubbel Audio</h1>
            <p class="text-slate-400">Lataa kaksi tiedostoa: toinen vasemmalle, toinen oikealle.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <!-- Vasen kanava -->
            <div>
                <div class="text-xs font-bold text-blue-400 mb-2 uppercase tracking-widest text-center">Koraani (Holy Quran)</div>
                <div class="channel-card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                        Vasen kanava (L)
                    </h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-400 mb-2">Vaihda tiedostoa</label>
                        <input type="file" id="fileL" accept="audio/*, .mp3, .m4a, .wav, .aac" class="block w-full text-sm text-slate-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-500 file:text-white
                            hover:file:bg-blue-600
                            cursor-pointer">
                    </div>

                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-medium text-slate-400">Nopeus</label>
                                <span id="speedValL" class="text-blue-400 font-mono text-sm">0.5x</span>
                            </div>
                            <input type="range" id="speedL" min="0.1" max="4" step="0.1" value="0.5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="reverseL" class="w-4 h-4 text-blue-500 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                            <label for="reverseL" class="ml-2 text-sm font-medium text-slate-300">Soita takaperin</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Oikea kanava -->
            <div>
                <div class="text-xs font-bold text-purple-400 mb-2 uppercase tracking-widest text-center">Das Kapital (English)</div>
                <div class="channel-card p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                        Oikea kanava (R)
                    </h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-400 mb-2">Vaihda tiedostoa</label>
                        <input type="file" id="fileR" accept="audio/*, .mp3, .m4a, .wav, .aac" class="block w-full text-sm text-slate-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-purple-500 file:text-white
                            hover:file:bg-purple-600
                            cursor-pointer">
                    </div>

                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-medium text-slate-400">Nopeus</label>
                                <span id="speedValR" class="text-purple-400 font-mono text-sm">1.5x</span>
                            </div>
                            <input type="range" id="speedR" min="0.1" max="4" step="0.1" value="1.5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
                        </div>

                        <div class="flex items-center">
                            <input type="checkbox" id="reverseR" class="w-4 h-4 text-purple-500 bg-slate-700 border-slate-600 rounded focus:ring-purple-500">
                            <label for="reverseR" class="ml-2 text-sm font-medium text-slate-300">Soita takaperin</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center gap-6">
            <!-- Mikseri -->
            <div class="w-full max-w-md channel-card p-6 rounded-2xl">
                <div class="flex justify-between mb-2">
                    <label class="text-sm font-medium text-slate-400 uppercase tracking-wider">Mikseri (L / R balance)</label>
                    <span id="mixVal" class="text-green-400 font-mono text-sm">Keski</span>
                </div>
                <input type="range" id="mixer" min="-1" max="1" step="0.01" value="0" class="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-green-500">
                <div class="flex justify-between mt-2 text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                    <span>Vasen</span>
                    <span>Molemmat</span>
                    <span>Oikea</span>
                </div>
            </div>

            <!-- Valinnat -->
            <div class="flex flex-wrap justify-center gap-4">
                <div class="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700">
                    <input type="checkbox" id="useLimiter" class="w-4 h-4 text-green-500 bg-slate-700 border-slate-600 rounded focus:ring-green-500">
                    <label for="useLimiter" class="text-xs font-semibold text-slate-300 uppercase tracking-wider cursor-pointer">Tasapainota (Limitteri)</label>
                </div>

                <div class="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700">
                    <input type="checkbox" id="loopAudio" class="w-4 h-4 text-blue-500 bg-slate-700 border-slate-600 rounded focus:ring-blue-500">
                    <label for="loopAudio" class="text-xs font-semibold text-slate-300 uppercase tracking-wider cursor-pointer">Looppaa toisto</label>
                </div>
            </div>

            <div id="unlockOverlay" class="flex flex-col items-center gap-4">
                <button id="unlockBtn" class="px-10 py-4 bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-black rounded-full transition-all shadow-xl shadow-yellow-500/20 animate-bounce text-center leading-tight">
                    KLIKKAA TÄSTÄ AKTIVOIDAKSESI ÄÄNET (iOS)
                </button>
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter text-center max-w-[250px]">
                    iPhone vaatii manuaalisen klikkauksen äänen aktivoimiseksi. Tarkista myös, ettei puhelin ole fyysisellä kytkimellä äänettömällä.
                </p>
            </div>

            <div id="controls" class="hidden flex gap-4">
                <button id="playBtn" disabled class="px-8 py-3 bg-green-500 hover:bg-green-600 disabled:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-full transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    SOITA
                </button>
                <button id="stopBtn" disabled class="px-8 py-3 bg-red-500 hover:bg-red-600 disabled:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-full transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path></svg>
                    PYSÄYTÄ
                </button>
            </div>
            <p id="status" class="text-sm text-slate-500 italic text-center">Ladataan oletustiedostoja...</p>
        </div>
    </div>

    <script>
        let audioCtx;
        let bufferL, bufferR;
        let sourceL, sourceR;
        let gainL, gainR;
        let isPlaying = false;

        const fileL = document.getElementById('fileL');
        const fileR = document.getElementById('fileR');
        const speedL = document.getElementById('speedL');
        const speedR = document.getElementById('speedR');
        const mixer = document.getElementById('mixer');
        const mixVal = document.getElementById('mixVal');
        const speedValL = document.getElementById('speedValL');
        const speedValR = document.getElementById('speedValR');
        const reverseL = document.getElementById('reverseL');
        const reverseR = document.getElementById('reverseR');
        const useLimiter = document.getElementById('useLimiter');
        const loopAudio = document.getElementById('loopAudio');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const unlockBtn = document.getElementById('unlockBtn');
        const unlockOverlay = document.getElementById('unlockOverlay');
        const controls = document.getElementById('controls');

        function updateGains() {
            if (!gainL || !gainR) return;
            const val = parseFloat(mixer.value);
            const volL = val > 0 ? 1 - val : 1;
            const volR = val < 0 ? 1 + val : 1;
            
            gainL.gain.setTargetAtTime(volL, audioCtx.currentTime, 0.05);
            gainR.gain.setTargetAtTime(volR, audioCtx.currentTime, 0.05);

            if (val === 0) mixVal.textContent = 'Keski';
            else if (val < 0) mixVal.textContent = 'Vasen ' + Math.round(Math.abs(val)*100) + '%';
            else mixVal.textContent = 'Oikea ' + Math.round(val*100) + '%';
        }

        mixer.addEventListener('input', updateGains);

        mixer.addEventListener('dblclick', () => {
            mixer.value = 0;
            updateGains();
        });

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)({
                    latencyHint: 'playback'
                });
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            return audioCtx;
        }

        unlockBtn.addEventListener('click', () => {
            const ctx = initAudio();
            
            // Soitetaan hetki hiljaisuutta herättämiseksi
            const osc = ctx.createOscillator();
            const silent = ctx.createGain();
            silent.gain.value = 0;
            osc.connect(silent);
            silent.connect(ctx.destination);
            osc.start(0);
            osc.stop(0.1);

            unlockOverlay.classList.add('hidden');
            controls.classList.remove('hidden');
            if (bufferL && bufferR) {
                status.textContent = 'Valmis toistoon';
            }
        });

        async function loadAudio(file) {
            const arrayBuffer = await file.arrayBuffer();
            const ctx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
            try {
                return await ctx.decodeAudioData(arrayBuffer);
            } catch (e) {
                console.error('decodeAudioData virhe:', e);
                throw new Error('Tiedostomuotoa ei tueta.');
            }
        }

        async function loadDefaults() {
            try {
                const [resL, resR] = await Promise.all([
                    fetch('001.mp3'),
                    fetch('002.mp3')
                ]);
                
                if (!resL.ok || !resR.ok) throw new Error('Oletustiedostoja ei löytynyt.');

                const [blobL, blobR] = await Promise.all([
                    resL.blob(),
                    resR.blob()
                ]);

                const tempCtx = new (window.AudioContext || window.webkitAudioContext)();
                const [bL, bR] = await Promise.all([
                    tempCtx.decodeAudioData(await blobL.arrayBuffer()),
                    tempCtx.decodeAudioData(await blobR.arrayBuffer())
                ]);
                bufferL = bL;
                bufferR = bR;
                tempCtx.close();
                
                checkReady();
            } catch (err) {
                console.error('Virhe oletustiedostojen latauksessa:', err);
                status.textContent = 'Oletustiedostojen lataus epäonnistui.';
            }
        }

        window.addEventListener('load', loadDefaults);

        fileL.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                const name = e.target.files[0].name;
                status.textContent = 'Ladataan: ' + name + '...';
                try {
                    bufferL = await loadAudio(e.target.files[0]);
                    checkReady();
                } catch (err) {
                    status.textContent = 'VIRHE (Vasen): ' + err.message;
                }
            }
        });

        fileR.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                const name = e.target.files[0].name;
                status.textContent = 'Ladataan: ' + name + '...';
                try {
                    bufferR = await loadAudio(e.target.files[0]);
                    checkReady();
                } catch (err) {
                    status.textContent = 'VIRHE (Oikea): ' + err.message;
                }
            }
        });

        function checkReady() {
            if (bufferL && bufferR) {
                playBtn.disabled = false;
                if (unlockOverlay.classList.contains('hidden')) {
                    status.textContent = 'Valmis toistoon';
                } else {
                    status.textContent = 'Oletukset ladattu, aktivoi äänet yltä';
                }
            }
        }

        speedL.addEventListener('input', (e) => {
            speedValL.textContent = e.target.value + 'x';
            if (sourceL) sourceL.playbackRate.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.1);
        });

        speedR.addEventListener('input', (e) => {
            speedValR.textContent = e.target.value + 'x';
            if (sourceR) sourceR.playbackRate.setTargetAtTime(e.target.value, audioCtx.currentTime, 0.1);
        });

        function createReversedBuffer(originalBuffer) {
            const ctx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
            const reversedBuffer = ctx.createBuffer(
                originalBuffer.numberOfChannels,
                originalBuffer.length,
                originalBuffer.sampleRate
            );

            for (let i = 0; i < originalBuffer.numberOfChannels; i++) {
                const chanData = originalBuffer.getChannelData(i);
                const revData = reversedBuffer.getChannelData(i);
                for (let j = 0, k = chanData.length - 1; j < chanData.length; j++, k--) {
                    revData[j] = chanData[k];
                }
            }
            return reversedBuffer;
        }

        playBtn.addEventListener('click', async () => {
            const ctx = initAudio();
            if (ctx.state === 'suspended') {
                await ctx.resume();
            }
            
            if (isPlaying) stop();
            
            isPlaying = true;
            playBtn.disabled = true;
            stopBtn.disabled = false;

            const merger = ctx.createChannelMerger(2);
            
            if (useLimiter.checked) {
                const limiter = ctx.createDynamicsCompressor();
                limiter.threshold.setValueAtTime(-12, ctx.currentTime);
                limiter.knee.setValueAtTime(30, ctx.currentTime);
                limiter.ratio.setValueAtTime(12, ctx.currentTime);
                limiter.attack.setValueAtTime(0.003, ctx.currentTime);
                limiter.release.setValueAtTime(0.25, ctx.currentTime);
                
                merger.connect(limiter);
                limiter.connect(ctx.destination);
            } else {
                merger.connect(ctx.destination);
            }

            gainL = ctx.createGain();
            gainR = ctx.createGain();
            
            updateGains();

            function setupChannel(buffer, speed, reverse, channelIndex, gainNode) {
                const source = ctx.createBufferSource();
                source.buffer = reverse ? createReversedBuffer(buffer) : buffer;
                source.playbackRate.value = speed;
                source.loop = loopAudio.checked;

                if (buffer.numberOfChannels > 1) {
                    const mixDown = ctx.createGain();
                    mixDown.gain.value = 1 / buffer.numberOfChannels;
                    source.connect(mixDown);
                    mixDown.connect(gainNode);
                } else {
                    source.connect(gainNode);
                }
                
                gainNode.connect(merger, 0, channelIndex);
                return source;
            }

            sourceL = setupChannel(bufferL, speedL.value, reverseL.checked, 0, gainL);
            sourceR = setupChannel(bufferR, speedR.value, reverseR.checked, 1, gainR);

            sourceL.start();
            sourceR.start();

            status.textContent = loopAudio.checked ? 'Toistetaan (loop)...' : 'Toistetaan...';

            let endedCount = 0;
            const onEnded = () => {
                if (loopAudio.checked) return;
                endedCount++;
                if (endedCount >= 2) stop();
            };
            sourceL.onended = onEnded;
            sourceR.onended = onEnded;
        });

        stopBtn.addEventListener('click', stop);

        function stop() {
            if (sourceL) {
                try { sourceL.stop(); } catch(e) {}
                sourceL = null;
            }
            if (sourceR) {
                try { sourceR.stop(); } catch(e) {}
                sourceR = null;
            }
            isPlaying = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = 'Toisto pysäytetty';
        }
    </script>
</body>
</html>
